<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StarMap Seoul</title>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        :root {
            --starbucks-green: #00704a;
            --text-primary: #1e3932;
            --bg-light: #f7f7f7;
            --map-bg: #3e2723;
            /* Dark Luxurious Brown */
            --map-border: #000000;
        }

        body {
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
            font-family: 'Pretendard', sans-serif;
            color: var(--text-primary);
            overflow: hidden;
        }

        #sidebar {
            width: 380px;
            background: white;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 15px rgba(0, 0, 0, 0.1);
            z-index: 1001;
        }

        .sidebar-header {
            padding: 24px 20px 15px;
            background: white;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            height: 32px;
        }

        .app-title {
            font-size: 1.4rem;
            font-weight: 800;
            color: var(--starbucks-green);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-actions {
            display: flex;
            align-items: center;
        }

        .header-actions span {
            cursor: pointer;
            color: #999;
            font-size: 0.85rem;
            margin-left: 10px;
            transition: 0.2s;
        }

        .header-actions span:hover {
            color: var(--starbucks-green);
        }

        #header-back-btn,
        #gu-reset-btn {
            display: none;
            border: none;
            font-size: 0.85rem;
            font-weight: 600;
            color: white;
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 8px;
            transition: opacity 0.2s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
        }

        #header-back-btn {
            background: var(--starbucks-green);
        }

        #gu-reset-btn {
            background: #d62828;
            margin-right: 5px;
        }

        /* Red for reset */

        #header-back-btn:hover,
        #gu-reset-btn:hover {
            opacity: 0.9;
        }

        .stats-container {
            background: var(--bg-light);
            border-radius: 12px;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
        }

        .stat-label {
            font-size: 0.75rem;
            color: #777;
        }

        .stat-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: #333;
        }

        .highlight {
            color: var(--starbucks-green);
        }

        .list-container {
            flex: 1;
            overflow-y: auto;
        }

        #item-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .gu-item,
        .store-item {
            padding: 16px 24px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .gu-item:hover,
        .store-item:hover {
            background-color: var(--bg-light);
        }

        .gu-count {
            background: #eee;
            color: #666;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .sidebar-footer {
            padding: 15px 20px;
            background: #fdfdfd;
            border-top: 1px solid #eee;
            font-size: 0.75rem;
            color: #aaa;
            line-height: 1.5;
        }

        .store-item {
            justify-content: start;
        }

        .checkbox-wrapper {
            margin-right: 15px;
        }

        .custom-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #ddd;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .visited .custom-checkbox {
            background: var(--starbucks-green);
            border-color: var(--starbucks-green);
        }

        .custom-checkbox::after {
            content: '✔';
            color: white;
            font-size: 12px;
            display: none;
        }

        .visited .custom-checkbox::after {
            display: block;
        }

        .store-info {
            flex: 1;
        }

        .store-dong {
            font-size: 0.8rem;
            color: #888;
        }

        .store-name {
            font-size: 1rem;
            font-weight: 600;
        }

        .visited .store-name {
            color: var(--starbucks-green);
            text-decoration: line-through;
            opacity: 0.8;
        }

        #map {
            flex: 1;
            background-color: var(--map-bg);
            position: relative;
            /* Ensure stacking context */
        }

        #map::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            /* Align to right edge */
            bottom: 0;
            width: 100%;
            /* Use full width so logo isn't clipped if tall */
            background-image: url('https://upload.wikimedia.org/wikipedia/en/thumb/d/d3/Starbucks_Corporation_Logo_2011.svg/1200px-Starbucks_Corporation_Logo_2011.svg.png');
            background-repeat: no-repeat;
            background-position: 350% center;
            /* Push horizontally past the right edge */
            background-size: auto 140%;
            /* Fit height (80% for aesthetics, or 100% for full bleed) */
            opacity: 0.51;
            pointer-events: none;
            z-index: 0;
        }

        .custom-tooltip {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #000;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            padding: 8px 12px;
            font-family: 'Pretendard';
        }

        .confetti {
            position: absolute;
            pointer-events: none;
            z-index: 9999;
            width: 8px;
            height: 8px;
        }
    </style>
</head>

<body>

    <div id="sidebar">
        <div class="sidebar-header">
            <div class="header-top">
                <div class="app-title">StarMap</div>
                <div class="header-right">
                    <button id="gu-reset-btn" onclick="resetGuData()">구 초기화</button>
                    <button id="header-back-btn" onclick="resetToSeoul()">← 뒤로가기</button>
                    <div class="header-actions" id="global-actions">
                        <span onclick="alert('kk30100@naver.com')">문의</span>
                        <span style="opacity:0.3">|</span>
                        <span onclick="resetUserData()">초기화</span>
                    </div>
                </div>
            </div>

            <div class="stats-container">
                <div>
                    <div class="stat-label">Total Stores</div>
                    <div class="stat-value" id="count-total">0</div>
                </div>
                <div style="text-align:right;">
                    <div class="stat-label">Visited</div>
                    <div class="stat-value highlight" id="count-checked">0</div>
                </div>
            </div>
        </div>

        <div class="list-container">
            <ul id="item-list"></ul>
        </div>

        <div class="sidebar-footer">
            <div>김대훈: kk30100@naver.com</div>
            <div>신동희: formation442@icloud.com</div>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const map = L.map('map', { zoomControl: false, center: [37.5665, 126.9780], zoom: 11, zoomSnap: 0.1 });

        const getColor = (r, isNoStore = false) => {
            if (isNoStore) return '#004d33';
            if (r >= 1) return '#004d33';
            if (r > 0.7) return '#00704a';
            if (r > 0.4) return '#2d9165';
            if (r > 0.1) return '#68ba93';
            return '#ffffff';
        }

        let guLayer, dongLayer;
        let visitedStores = new Set(JSON.parse(localStorage.getItem('visited_stores') || '[]'));

        // Data Containers
        let allStoresData = [];
        let storesByGu = {};
        let guStats = {};
        let currentLevel = 'GU';
        let currentGu = null;

        Promise.all([
            fetch('/static/seoul_gu_map.geojson').then(r => r.json()),
            fetch('/static/seoul_map.geojson').then(r => r.json()),
            fetch('/api/dong-stats').then(r => r.json())
        ]).then(([guGeo, dongGeo, stores]) => {
            allStoresData = stores;
            processData();

            dongLayer = L.geoJSON(dongGeo, {
                style: { opacity: 0, fillOpacity: 0, interactive: false },
                onEachFeature: (f, l) => {
                    l.bindTooltip(`<b>${f.properties.adm_nm.split(' ').pop()}</b>`, { className: 'custom-tooltip', sticky: true });
                }
            }).addTo(map);

            guLayer = L.geoJSON(guGeo, {
                style: styleGuMode,
                onEachFeature: (f, l) => {
                    const name = f.properties.name || f.properties.SIG_KOR_NM;
                    l.bindTooltip(`<b>${name}</b>`, { className: 'custom-tooltip', sticky: true });
                    l.on('click', (e) => drillDownToGu(name, e.target.getBounds()));
                    l.on('mouseover', () => { if (currentLevel === 'GU') l.setStyle({ weight: 3 }); });
                    l.on('mouseout', () => { if (currentLevel === 'GU') l.setStyle(styleGuMode(f)); });
                }
            }).addTo(map);

            renderGuList();
        });

        function processData() {
            storesByGu = {};
            guStats = {};

            allStoresData.forEach(s => {
                if (!storesByGu[s.gu]) storesByGu[s.gu] = [];
                storesByGu[s.gu].push(s);

                if (!guStats[s.gu]) guStats[s.gu] = { t: 0, v: 0 };
                guStats[s.gu].t++;
                if (visitedStores.has(s.store_name)) guStats[s.gu].v++;
            });
        }

        function resetToSeoul() {
            currentLevel = 'GU';
            currentGu = null;
            document.getElementById('header-back-btn').style.display = 'none';
            document.getElementById('gu-reset-btn').style.display = 'none';
            document.getElementById('global-actions').style.display = 'flex';

            if (guLayer) map.fitBounds(guLayer.getBounds(), { padding: [20, 20], duration: 0.8 });
            else map.flyTo([37.5665, 126.9780], 11);

            guLayer.setStyle(styleGuMode);
            guLayer.eachLayer(l => l.getElement().style.pointerEvents = 'auto');
            dongLayer.setStyle({ opacity: 0, fillOpacity: 0, interactive: false });

            renderGuList();
        }

        function drillDownToGu(guName, bounds) {
            currentLevel = 'DONG';
            currentGu = guName;
            document.getElementById('header-back-btn').style.display = 'block';
            document.getElementById('gu-reset-btn').style.display = 'block';
            document.getElementById('global-actions').style.display = 'none';

            map.flyToBounds(bounds, { padding: [50, 50], duration: 0.8 });
            updateDongLayer(guName);
        }

        function updateDongLayer(guName) {
            const stores = storesByGu[guName] || [];
            const dongStats = {};

            stores.forEach(s => {
                if (!dongStats[s.dong]) dongStats[s.dong] = { t: 0, v: 0 };
                dongStats[s.dong].t++;
                if (visitedStores.has(s.store_name)) dongStats[s.dong].v++;
            });

            guLayer.setStyle({ opacity: 0, fillOpacity: 0, interactive: false });

            dongLayer.eachLayer(layer => {
                if (layer.feature.properties.sggnm === guName) {
                    const dName = layer.feature.properties.adm_nm.split(' ').pop();
                    const stat = dongStats[dName] || { v: 0, t: 0 };

                    const isNoStore = (stat.t === 0);
                    const ratio = stat.t ? stat.v / stat.t : 0;

                    layer.setStyle({
                        fillColor: getColor(ratio, isNoStore),
                        weight: 1,
                        color: 'black',
                        opacity: 1,
                        fillOpacity: 1,
                        interactive: true
                    });
                } else {
                    layer.setStyle({ opacity: 0, fillOpacity: 0, interactive: false });
                }
            });
            renderStoreList(stores, dongStats);
        }

        function renderGuList() {
            const list = document.getElementById('item-list'); list.innerHTML = '';
            let total = 0;
            const sortedGus = Object.keys(guStats).sort();

            sortedGus.forEach(gu => {
                const s = guStats[gu];
                total += s.t;
                const li = document.createElement('li'); li.className = 'gu-item';
                li.innerHTML = `<span style="font-weight:600">${gu}</span><span class="gu-count">${s.t}</span>`;
                li.onclick = () => {
                    guLayer.eachLayer(l => {
                        const name = l.feature.properties.name || l.feature.properties.SIG_KOR_NM;
                        if (name === gu) drillDownToGu(gu, l.getBounds());
                    });
                };
                list.appendChild(li);
            });

            document.getElementById('count-total').textContent = total;
            document.getElementById('count-checked').textContent = visitedStores.size;
        }

        function renderStoreList(stores, dongStats) {
            const list = document.getElementById('item-list'); list.innerHTML = '';
            const frag = document.createDocumentFragment();
            let visitedInGu = 0;

            stores.forEach(s => {
                const li = document.createElement('li');
                const isVisited = visitedStores.has(s.store_name);
                if (isVisited) visitedInGu++;

                li.className = `store-item ${isVisited ? 'visited' : ''}`;
                li.onclick = () => toggleVisit(s.store_name, s.dong, s.gu, li);
                li.innerHTML = `
                    <div class="checkbox-wrapper"><div class="custom-checkbox"></div></div>
                    <div class="store-info"><div class="store-dong">${s.dong}</div><div class="store-name">${s.store_name}</div></div>
                `;
                frag.appendChild(li);
            });
            list.appendChild(frag);

            document.getElementById('count-total').textContent = stores.length;
            document.getElementById('count-checked').textContent = visitedInGu;
        }

        function toggleVisit(storeName, dongName, guName, li) {
            const isVisited = visitedStores.has(storeName);

            const storesInDong = storesByGu[guName].filter(s => s.dong === dongName);
            const totalInDong = storesInDong.length;
            const visitedInDong = storesInDong.filter(s => visitedStores.has(s.store_name)).length;
            const wasDongFull = totalInDong > 0 && visitedInDong === totalInDong;

            const totalInGu = guStats[guName].t;
            const visitedInGu = guStats[guName].v;
            const wasGuFull = totalInGu > 0 && visitedInGu === totalInGu;

            if (isVisited) {
                visitedStores.delete(storeName);
                li.classList.remove('visited');
                guStats[guName].v--;
            } else {
                visitedStores.add(storeName);
                li.classList.add('visited');
                guStats[guName].v++;
            }

            localStorage.setItem('visited_stores', JSON.stringify([...visitedStores]));

            const newVisitedInDong = isVisited ? visitedInDong - 1 : visitedInDong + 1;
            const isDongFull = totalInDong > 0 && newVisitedInDong === totalInDong;

            const newVisitedInGu = isVisited ? visitedInGu - 1 : visitedInGu + 1;
            const isGuFull = totalInGu > 0 && newVisitedInGu === totalInGu;

            if (!wasGuFull && isGuFull) {
                createFireworks();
            } else if (!wasDongFull && isDongFull) {
                createConfetti(15);
            }

            if (currentLevel === 'GU') {
                document.getElementById('count-checked').textContent = visitedStores.size;
            } else {
                let currentVal = parseInt(document.getElementById('count-checked').textContent) || 0;
                document.getElementById('count-checked').textContent = currentVal + (isVisited ? -1 : 1);
            }

            updateDongLayer(guName);
        }

        function createConfetti(amount = 15) {
            const colors = ['#00704a', '#d4e9e2', '#eac784', '#ff6b6b'];
            for (let i = 0; i < amount; i++) {
                const el = document.createElement('div'); el.className = 'confetti';
                el.style.backgroundColor = colors[Math.floor(Math.random() * 4)];
                el.style.left = Math.random() * 100 + 'vw'; el.style.top = '-10px';
                document.body.appendChild(el);
                const anim = el.animate([{ transform: 'translate(0,0)' }, { transform: `translate(${Math.random() * 100 - 50}px, 100vh) rotate(720deg)` }], { duration: 1000 + Math.random() * 1000 });
                anim.onfinish = () => el.remove();
            }
        }

        function createFireworks() {
            const fireBurst = (delay) => {
                setTimeout(() => {
                    // Confetti Rain
                    createConfetti(40);

                    // Powerful Burst
                    const particleCount = 80;
                    const colors = ['#ff0000', '#ffd700', '#ffffff', '#00ff00', '#00704a', '#00ffff', '#ff00ff'];
                    // Pick ONE color for the entire burst
                    const burstColor = colors[Math.floor(Math.random() * colors.length)];

                    const startX = 50 + (Math.random() * 20 - 10);
                    const startY = 50 + (Math.random() * 20 - 10);

                    for (let i = 0; i < particleCount; i++) {
                        const el = document.createElement('div');
                        el.className = 'confetti';

                        el.style.backgroundColor = burstColor;
                        el.style.boxShadow = `0 0 6px 1px ${burstColor}`;
                        el.style.borderRadius = '50%';
                        el.style.width = (Math.random() * 6 + 4) + 'px';
                        el.style.height = el.style.width;
                        el.style.left = startX + 'vw';
                        el.style.top = startY + 'vh';

                        document.body.appendChild(el);

                        const angle = Math.random() * Math.PI * 2;
                        const velocity = 200 + Math.random() * 500;
                        const tx = Math.cos(angle) * velocity;
                        const ty = Math.sin(angle) * velocity;

                        const anim = el.animate([
                            { transform: 'translate(0,0) scale(1)', opacity: 1 },
                            { transform: `translate(${tx * 0.5}px, ${ty * 0.5}px) scale(0.8)`, opacity: 0.8, offset: 0.4 },
                            { transform: `translate(${tx}px, ${ty + 200}px) scale(0)`, opacity: 0 }
                        ], {
                            duration: 1200 + Math.random() * 800,
                            easing: 'cubic-bezier(0, .9, .57, 1)'
                        });

                        anim.onfinish = () => el.remove();
                    }
                }, delay);
            };

            for (let k = 0; k < 5; k++) {
                fireBurst(k * 500);
            }
        }

        function styleGuMode(f) {
            const name = f.properties.name || f.properties.SIG_KOR_NM;
            const s = guStats[name] || { t: 0, v: 0 };
            return { fillColor: getColor(s.t ? s.v / s.t : 0), weight: 1.5, color: 'black', opacity: 1, fillOpacity: 1 };
        }

        function resetUserData() {
            if (confirm("모든 기록을 초기화하시겠습니까?")) { localStorage.removeItem('visited_stores'); location.reload(); }
        }

        function resetGuData() {
            if (!currentGu || !confirm(`${currentGu}의 기록을 초기화하시겠습니까?`)) return;

            const stores = storesByGu[currentGu] || [];
            stores.forEach(s => {
                if (visitedStores.has(s.store_name)) {
                    visitedStores.delete(s.store_name);
                    guStats[currentGu].v--;
                }
            });
            localStorage.setItem('visited_stores', JSON.stringify([...visitedStores]));

            updateDongLayer(currentGu);
            document.getElementById('count-checked').textContent = 0;
        }
    </script>
</body>

</html>