<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StarMap Seoul</title>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        :root {
            --starbucks-green: #00704a;
            --text-primary: #1e3932;
            --bg-light: #f7f7f7;
            --map-bg: #3e2723;
            /* Dark Luxurious Brown */
            --map-border: #000000;
        }

        body {
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
            font-family: 'Pretendard', sans-serif;
            color: var(--text-primary);
            overflow: hidden;
        }

        #sidebar {
            width: 380px;
            background: white;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 15px rgba(0, 0, 0, 0.1);
            z-index: 1001;
        }

        .sidebar-header {
            padding: 24px 20px 15px;
            background: white;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            height: 32px;
        }

        .app-title {
            font-size: 1.4rem;
            font-weight: 800;
            color: var(--starbucks-green);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-actions {
            display: flex;
            align-items: center;
        }

        .header-actions span {
            cursor: pointer;
            color: #999;
            font-size: 0.85rem;
            margin-left: 10px;
            transition: 0.2s;
        }

        .header-actions span:hover {
            color: var(--starbucks-green);
        }

        #header-back-btn,
        #gu-reset-btn {
            display: none;
            border: none;
            font-size: 0.85rem;
            font-weight: 600;
            color: white;
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 8px;
            transition: opacity 0.2s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
        }

        #header-back-btn {
            background: var(--starbucks-green);
        }

        #gu-reset-btn {
            background: #d62828;
            margin-right: 5px;
        }

        /* Red for reset */

        #header-back-btn:hover,
        #gu-reset-btn:hover {
            opacity: 0.9;
        }

        .stats-container {
            background: var(--bg-light);
            border-radius: 12px;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
        }

        .stat-label {
            font-size: 0.75rem;
            color: #777;
        }

        .stat-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: #333;
        }

        .highlight {
            color: var(--starbucks-green);
        }

        .list-container {
            flex: 1;
            overflow-y: auto;
        }

        #item-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .gu-item,
        .store-item {
            padding: 16px 24px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .gu-item:hover,
        .store-item:hover {
            background-color: var(--bg-light);
        }

        .gu-count {
            background: #eee;
            color: #666;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .sidebar-footer {
            padding: 15px 20px;
            background: #fdfdfd;
            border-top: 1px solid #eee;
            font-size: 0.75rem;
            color: #aaa;
            line-height: 1.5;
        }

        .store-item {
            justify-content: start;
        }

        .checkbox-wrapper {
            margin-right: 15px;
        }

        .custom-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #ddd;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .visited .custom-checkbox {
            background: var(--starbucks-green);
            border-color: var(--starbucks-green);
        }

        .custom-checkbox::after {
            content: 'âœ”';
            color: white;
            font-size: 12px;
            display: none;
        }

        .visited .custom-checkbox::after {
            display: block;
        }

        .store-info {
            flex: 1;
        }

        .store-dong {
            font-size: 0.8rem;
            color: #888;
        }

        .store-name {
            font-size: 1rem;
            font-weight: 600;
        }

        .visited .store-name {
            color: var(--starbucks-green);
            text-decoration: line-through;
            opacity: 0.8;
        }

        #map {
            flex: 1;
            background-color: var(--map-bg);
            position: relative;
            /* Ensure stacking context */
        }

        #map::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            /* Align to right edge */
            bottom: 0;
            width: 100%;
            /* Use full width so logo isn't clipped if tall */
            background-image: url('https://upload.wikimedia.org/wikipedia/en/thumb/d/d3/Starbucks_Corporation_Logo_2011.svg/1200px-Starbucks_Corporation_Logo_2011.svg.png');
            background-repeat: no-repeat;
            background-position: 350% center;
            /* Push horizontally past the right edge */
            background-size: auto 140%;
            /* Fit height (80% for aesthetics, or 100% for full bleed) */
            opacity: 0.51;
            pointer-events: none;
            z-index: 0;
        }

        .custom-tooltip {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #000;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            padding: 8px 12px;
            font-family: 'Pretendard';
        }

        .confetti {
            position: absolute;
            pointer-events: none;
            z-index: 9999;
            width: 8px;
            height: 8px;
        }

        /* Form Styles for Welcome Modal */
        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 0.9rem;
        }

        .chip-container {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .chip {
            padding: 8px 16px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            color: #555;
            transition: 0.2s;
            background: #fff;
        }

        .chip:hover {
            background: #f0f0f0;
        }

        .chip.selected {
            background: var(--starbucks-green);
            color: white;
            border-color: var(--starbucks-green);
            key-shadow: 0 2px 5px rgba(0, 112, 74, 0.3);
            font-weight: 600;
        }

        .primary-btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            background: var(--starbucks-green);
            color: white;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            opacity: 1;
            transition: 0.2s;
            margin-top: 10px;
        }

        .primary-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .primary-btn:not(:disabled):hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 112, 74, 0.2);
        }

        /* Info Button & Modal */
        #info-btn,
        #profile-btn {
            position: absolute;
            left: 20px;
            z-index: 1000;
            /* Above map */
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: 700;
            color: var(--starbucks-green);
            font-size: 1.2rem;
            border: 2px solid var(--starbucks-green);
            transition: transform 0.2s;
        }

        #info-btn {
            top: 20px;
        }

        #profile-btn {
            top: 70px;
            font-size: 1.4rem;
        }

        #info-btn:hover,
        #profile-btn:hover {
            transform: scale(1.1);
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            position: relative;
            animation: modalPop 0.3s ease-out;
        }

        @keyframes modalPop {
            from {
                transform: scale(0.9);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
        }

        .modal-close:hover {
            color: #333;
        }

        .guide-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--starbucks-green);
            margin-bottom: 20px;
            text-align: center;
        }

        .guide-section {
            margin-bottom: 15px;
            line-height: 1.5;
            font-size: 0.95rem;
        }

        .guide-section strong {
            display: block;
            margin-bottom: 4px;
            color: #333;
        }

        .guide-note {
            background: #f0fdf4;
            padding: 10px;
            border-radius: 8px;
            color: #1e3932;
            font-size: 0.85rem;
            margin-bottom: 20px;
            border-left: 3px solid var(--starbucks-green);
        }

        .guide-controls {
            display: grid;
            gap: 8px;
            font-size: 0.9rem;
            color: #555;
            background: #fafafa;
            padding: 15px;
            border-radius: 10px;
        }

        .footer-note {
            margin-top: 15px;
            text-align: center;
            font-size: 0.8rem;
            color: #aaa;
        }
    </style>

    <!-- Google Tag Manager -->
    <script>(function (w, d, s, l, i) {
            w[l] = w[l] || []; w[l].push({
                'gtm.start':
                    new Date().getTime(), event: 'gtm.js'
            }); var f = d.getElementsByTagName(s)[0],
                j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : ''; j.async = true; j.src =
                    'https://www.googletagmanager.com/gtm.js?id=' + i + dl; f.parentNode.insertBefore(j, f);
        })(window, document, 'script', 'dataLayer', 'GTM-TNMFBPBD');</script>
    <!-- End Google Tag Manager -->
</head>

<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TNMFBPBD" height="0" width="0"
            style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

    <!-- Welcome Modal (First Visit) -->
    <div id="welcome-modal" class="modal-overlay" style="z-index: 2001;">
        <div class="modal-content">
            <div class="guide-title">í™˜ì˜í•©ë‹ˆë‹¤! ğŸ‘‹</div>
            <p style="text-align:center; color:#555; margin-bottom:25px; line-height:1.5; font-size:0.95rem;">
                StarMap Seoulì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤.<br>
                ë” ë‚˜ì€ ì„œë¹„ìŠ¤ ì œê³µì„ ìœ„í•´ ê°„ë‹¨í•œ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.
            </p>

            <div class="input-group">
                <label>ì—°ë ¹ëŒ€</label>
                <div class="chip-container" id="age-selector">
                    <div class="chip" onclick="selectChip('age', '10ëŒ€')">10ëŒ€</div>
                    <div class="chip" onclick="selectChip('age', '20ëŒ€')">20ëŒ€</div>
                    <div class="chip" onclick="selectChip('age', '30ëŒ€')">30ëŒ€</div>
                    <div class="chip" onclick="selectChip('age', '40ëŒ€')">40ëŒ€</div>
                    <div class="chip" onclick="selectChip('age', '50ëŒ€')">50ëŒ€</div>
                    <div class="chip" onclick="selectChip('age', '60ëŒ€+')">60ëŒ€+</div>
                </div>
            </div>

            <div class="input-group">
                <label>ì„±ë³„</label>
                <div class="chip-container" id="gender-selector">
                    <div class="chip" onclick="selectChip('gender', 'ë‚¨ì„±')">ë‚¨ì„±</div>
                    <div class="chip" onclick="selectChip('gender', 'ì—¬ì„±')">ì—¬ì„±</div>
                </div>
            </div>

            <button id="start-btn" class="primary-btn" disabled onclick="submitUserInfo()">ì…ë ¥ ì™„ë£Œ ë° ì‹œì‘í•˜ê¸°</button>
        </div>
    </div>

    <div id="info-modal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal(event, true)">&times;</span>
            <div class="guide-title">ì„œìš¸ ìŠ¤íƒ€ë²…ìŠ¤ ë„ì¥ê¹¨ê¸°</div>

            <div class="guide-section">
                <strong>1. ì§€ì—­ ì„ íƒ ğŸ—ºï¸</strong>
                ì§€ë„ë‚˜ ì™¼ìª½ ëª©ë¡ì—ì„œ ë°©ë¬¸í•œ <b>êµ¬(Gu)</b>ë¥¼ ì„ íƒí•˜ì„¸ìš”.
            </div>

            <div class="guide-section">
                <strong>2. ë°©ë¬¸ ì²´í¬ âœ…</strong>
                ë‹¤ë…€ì˜¨ ì§€ì ì„ ë¦¬ìŠ¤íŠ¸ì—ì„œ í´ë¦­í•˜ì—¬ ì²´í¬í•˜ì„¸ìš”.<br>
                ì§„í–‰ë„ì— ë”°ë¼ <b>ë™/êµ¬ì˜ ìƒ‰ìƒ</b>ì´ ì ì  ì§„í•´ì§‘ë‹ˆë‹¤! ğŸŒ¿
            </div>

            <div class="guide-note">
                * ì´ˆë¡ìƒ‰ìœ¼ë¡œ í‘œì‹œëœ ë™ì€ ìŠ¤íƒ€ë²…ìŠ¤ê°€ ì—†ëŠ” ì§€ì—­ì…ë‹ˆë‹¤.<br>
                (ìë™ 100% ì™„ë£Œ ì²˜ë¦¬)
            </div>

            <div class="guide-controls">
                <div>ğŸ”„ <b>êµ¬ ì´ˆê¸°í™”</b>: í˜„ì¬ ë³´ê³  ìˆëŠ” êµ¬ì˜ ê¸°ë¡ë§Œ ì‚­ì œ</div>
                <div>â® <b>ë’¤ë¡œê°€ê¸°</b>: ì„œìš¸ ì „ì²´ ì§€ë„ë¡œ ëŒì•„ê°€ê¸°</div>
                <div>ğŸ—‘ <b>ì „ì²´ ì´ˆê¸°í™”</b>: ëª¨ë“  ë°©ë¬¸ ê¸°ë¡ ì‚­ì œ (ìš°ì¸¡ ìƒë‹¨)</div>
            </div>

            <div class="footer-note">
                ì˜¤ë¥˜ ì œë³´ë‚˜ ê±´ì˜ ì‚¬í•­ì€ ìš°ì¸¡ ìƒë‹¨ì˜ 'ë¬¸ì˜'ë¥¼ ì´ìš©í•´ì£¼ì„¸ìš”.<br>
                v1.0.0
            </div>
        </div>
    </div>

    <div id="sidebar">
        <div class="sidebar-header">
            <div class="header-top">
                <div class="app-title">StarMap</div>
                <div class="header-right">
                    <button id="gu-reset-btn" onclick="resetGuData()">êµ¬ ì´ˆê¸°í™”</button>
                    <button id="header-back-btn" onclick="resetToSeoul()">â† ë’¤ë¡œê°€ê¸°</button>
                    <div class="header-actions" id="global-actions">
                        <span
                            onclick="alert('kk30100@naver.com'); window.dataLayer.push({'event': 'contact_click'});">ë¬¸ì˜</span>
                        <span style="opacity:0.3">|</span>
                        <span onclick="resetUserData()">ì´ˆê¸°í™”</span>
                    </div>
                </div>
            </div>

            <div class="stats-container">
                <div>
                    <div class="stat-label">Total Stores</div>
                    <div class="stat-value" id="count-total">0</div>
                </div>
                <div style="text-align:right;">
                    <div class="stat-label">Visited</div>
                    <div class="stat-value highlight" id="count-checked">0</div>
                </div>
            </div>
        </div>

        <div class="list-container">
            <ul id="item-list"></ul>
        </div>

        <div class="sidebar-footer">
            <div>ê¹€ëŒ€í›ˆ: kk30100@naver.com</div>
            <div>ì‹ ë™í¬: formation442@icloud.com</div>
        </div>
    </div>

    <div id="map">
        <div id="info-btn" onclick="openModal()">i</div>
        <div id="profile-btn" onclick="openWelcomeModal()">â˜…</div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const map = L.map('map', { zoomControl: false, center: [37.5665, 126.9780], zoom: 11, zoomSnap: 0.1 });
        window.dataLayer = window.dataLayer || []; // Init dataLayer

        const getColor = (r, isNoStore = false) => {
            if (isNoStore) return '#004d33';
            if (r >= 1) return '#004d33';
            if (r > 0.7) return '#00704a';
            if (r > 0.4) return '#2d9165';
            if (r > 0.1) return '#68ba93';
            return '#ffffff';
        }

        let guLayer, dongLayer;
        let visitedStores = new Set(JSON.parse(localStorage.getItem('visited_stores') || '[]'));

        // Data Containers
        let allStoresData = [];
        let storesByGu = {};
        let guStats = {};
        let currentLevel = 'GU';
        let currentGu = null;

        Promise.all([
            fetch('/static/seoul_gu_map.geojson').then(r => r.json()),
            fetch('/static/seoul_map.geojson').then(r => r.json()),
            fetch('/api/dong-stats').then(r => r.json())
        ]).then(([guGeo, dongGeo, stores]) => {
            allStoresData = stores;
            processData();

            dongLayer = L.geoJSON(dongGeo, {
                style: { opacity: 0, fillOpacity: 0, interactive: false },
                onEachFeature: (f, l) => {
                    l.bindTooltip(`<b>${f.properties.adm_nm.split(' ').pop()}</b>`, { className: 'custom-tooltip', sticky: true });
                }
            }).addTo(map);

            guLayer = L.geoJSON(guGeo, {
                style: styleGuMode,
                onEachFeature: (f, l) => {
                    const name = f.properties.name || f.properties.SIG_KOR_NM;
                    l.bindTooltip(`<b>${name}</b>`, { className: 'custom-tooltip', sticky: true });
                    l.on('click', (e) => drillDownToGu(name, e.target.getBounds()));
                    l.on('mouseover', () => { if (currentLevel === 'GU') l.setStyle({ weight: 3 }); });
                    l.on('mouseout', () => { if (currentLevel === 'GU') l.setStyle(styleGuMode(f)); });
                }
            }).addTo(map);

            renderGuList();

            // [FIX] Ensure map fits Seoul properly after layout is ready
            setTimeout(() => {
                map.invalidateSize();
                map.fitBounds(guLayer.getBounds(), { padding: [30, 30], maxZoom: 12 });
            }, 100);
        });

        // [FIX] Handle window resize to keep map properly sized
        window.addEventListener('resize', () => {
            map.invalidateSize();
            if (currentLevel === 'GU' && guLayer) {
                map.fitBounds(guLayer.getBounds(), { padding: [30, 30], maxZoom: 12, animate: false });
            }
        });

        function processData() {
            storesByGu = {};
            guStats = {};

            allStoresData.forEach(s => {
                if (!storesByGu[s.gu]) storesByGu[s.gu] = [];
                storesByGu[s.gu].push(s);

                if (!guStats[s.gu]) guStats[s.gu] = { t: 0, v: 0 };
                guStats[s.gu].t++;
                if (visitedStores.has(s.store_name)) guStats[s.gu].v++;
            });
        }

        function resetToSeoul() {
            currentLevel = 'GU';
            currentGu = null;
            document.getElementById('header-back-btn').style.display = 'none';
            document.getElementById('gu-reset-btn').style.display = 'none';
            document.getElementById('global-actions').style.display = 'flex';

            // First, reset any zoom constraints that might prevent fitting
            map.setMinZoom(1);
            map.setMaxBounds(null);

            // Force map to recalculate its size (fixes layout issues)
            map.invalidateSize();

            if (guLayer) {
                const bounds = guLayer.getBounds();
                // Use maxZoom to prevent over-zooming on small screens
                map.fitBounds(bounds, { padding: [30, 30], maxZoom: 12, animate: true, duration: 0.5 });

                // Re-apply constraints after animation completes
                setTimeout(() => {
                    map.setMaxBounds(bounds.pad(0.3));
                    map.setMinZoom(map.getZoom() - 0.5);
                }, 600);
            } else {
                map.flyTo([37.5665, 126.9780], 11);
            }

            guLayer.setStyle(styleGuMode);
            guLayer.eachLayer(l => l.getElement().style.pointerEvents = 'auto');
            dongLayer.setStyle({ opacity: 0, fillOpacity: 0, interactive: false });

            renderGuList();
        }

        function drillDownToGu(guName, bounds) {
            currentLevel = 'DONG';
            currentGu = guName;

            // GTM Tracking
            window.dataLayer.push({
                'event': 'view_gu_detail',
                'gu_name': guName
            });

            document.getElementById('header-back-btn').style.display = 'block';
            document.getElementById('gu-reset-btn').style.display = 'block';
            document.getElementById('global-actions').style.display = 'none';

            map.flyToBounds(bounds, { padding: [50, 50], duration: 0.8 });
            updateDongLayer(guName);
        }

        function updateDongLayer(guName) {
            const stores = storesByGu[guName] || [];
            const dongStats = {};

            stores.forEach(s => {
                if (!dongStats[s.dong]) dongStats[s.dong] = { t: 0, v: 0 };
                dongStats[s.dong].t++;
                if (visitedStores.has(s.store_name)) dongStats[s.dong].v++;
            });

            guLayer.setStyle({ opacity: 0, fillOpacity: 0, interactive: false });

            dongLayer.eachLayer(layer => {
                if (layer.feature.properties.sggnm === guName) {
                    const dName = layer.feature.properties.adm_nm.split(' ').pop();
                    const stat = dongStats[dName] || { v: 0, t: 0 };

                    const isNoStore = (stat.t === 0);
                    const ratio = stat.t ? stat.v / stat.t : 0;

                    layer.setStyle({
                        fillColor: getColor(ratio, isNoStore),
                        weight: 1,
                        color: 'black',
                        opacity: 1,
                        fillOpacity: 1,
                        interactive: true
                    });
                } else {
                    layer.setStyle({ opacity: 0, fillOpacity: 0, interactive: false });
                }
            });
            renderStoreList(stores, dongStats);
        }

        function renderGuList() {
            const list = document.getElementById('item-list'); list.innerHTML = '';
            let total = 0;
            const sortedGus = Object.keys(guStats).sort();

            sortedGus.forEach(gu => {
                const s = guStats[gu];
                total += s.t;
                const li = document.createElement('li'); li.className = 'gu-item';
                li.innerHTML = `<span style="font-weight:600">${gu}</span><span class="gu-count">${s.t}</span>`;
                li.onclick = () => {
                    guLayer.eachLayer(l => {
                        const name = l.feature.properties.name || l.feature.properties.SIG_KOR_NM;
                        if (name === gu) drillDownToGu(gu, l.getBounds());
                    });
                };
                list.appendChild(li);
            });

            document.getElementById('count-total').textContent = total;
            document.getElementById('count-checked').textContent = visitedStores.size;
        }

        function renderStoreList(stores, dongStats) {
            const list = document.getElementById('item-list'); list.innerHTML = '';
            const frag = document.createDocumentFragment();
            let visitedInGu = 0;

            stores.forEach(s => {
                const li = document.createElement('li');
                const isVisited = visitedStores.has(s.store_name);
                if (isVisited) visitedInGu++;

                li.className = `store-item ${isVisited ? 'visited' : ''}`;
                li.onclick = () => toggleVisit(s.store_name, s.dong, s.gu, li);
                li.innerHTML = `
                    <div class="checkbox-wrapper"><div class="custom-checkbox"></div></div>
                    <div class="store-info"><div class="store-dong">${s.dong}</div><div class="store-name">${s.store_name}</div></div>
                `;
                frag.appendChild(li);
            });
            list.appendChild(frag);

            document.getElementById('count-total').textContent = stores.length;
            document.getElementById('count-checked').textContent = visitedInGu;
        }

        function toggleVisit(storeName, dongName, guName, li) {
            const isVisited = visitedStores.has(storeName);

            const storesInDong = storesByGu[guName].filter(s => s.dong === dongName);
            const totalInDong = storesInDong.length;
            const visitedInDong = storesInDong.filter(s => visitedStores.has(s.store_name)).length;
            const wasDongFull = totalInDong > 0 && visitedInDong === totalInDong;

            const totalInGu = guStats[guName].t;
            const visitedInGu = guStats[guName].v;
            const wasGuFull = totalInGu > 0 && visitedInGu === totalInGu;

            if (isVisited) {
                visitedStores.delete(storeName);
                li.classList.remove('visited');
                guStats[guName].v--;
                window.dataLayer.push({ 'event': 'store_visit_toggle', 'store_name': storeName, 'action': 'remove', 'gu_name': guName });
            } else {
                visitedStores.add(storeName);
                li.classList.add('visited');
                guStats[guName].v++;
                window.dataLayer.push({ 'event': 'store_visit_toggle', 'store_name': storeName, 'action': 'add', 'gu_name': guName });
            }

            localStorage.setItem('visited_stores', JSON.stringify([...visitedStores]));

            const newVisitedInDong = isVisited ? visitedInDong - 1 : visitedInDong + 1;
            const isDongFull = totalInDong > 0 && newVisitedInDong === totalInDong;

            const newVisitedInGu = isVisited ? visitedInGu - 1 : visitedInGu + 1;
            const isGuFull = totalInGu > 0 && newVisitedInGu === totalInGu;

            if (!wasGuFull && isGuFull) {
                createFireworks();
                window.dataLayer.push({ 'event': 'achievement_unlocked', 'type': 'gu_completion', 'gu_name': guName });
            } else if (!wasDongFull && isDongFull) {
                createConfetti(15);
                window.dataLayer.push({ 'event': 'achievement_unlocked', 'type': 'dong_completion', 'gu_name': guName, 'dong_name': dongName });
            }

            if (currentLevel === 'GU') {
                document.getElementById('count-checked').textContent = visitedStores.size;
            } else {
                let currentVal = parseInt(document.getElementById('count-checked').textContent) || 0;
                document.getElementById('count-checked').textContent = currentVal + (isVisited ? -1 : 1);
            }

            updateDongLayer(guName);
        }

        function createConfetti(amount = 15) {
            const colors = ['#00704a', '#d4e9e2', '#eac784', '#ff6b6b'];
            for (let i = 0; i < amount; i++) {
                const el = document.createElement('div'); el.className = 'confetti';
                el.style.backgroundColor = colors[Math.floor(Math.random() * 4)];
                el.style.left = Math.random() * 100 + 'vw'; el.style.top = '-10px';
                document.body.appendChild(el);
                const anim = el.animate([{ transform: 'translate(0,0)' }, { transform: `translate(${Math.random() * 100 - 50}px, 100vh) rotate(720deg)` }], { duration: 1000 + Math.random() * 1000 });
                anim.onfinish = () => el.remove();
            }
        }

        function createFireworks() {
            const fireBurst = (delay) => {
                setTimeout(() => {
                    // Confetti Rain
                    createConfetti(40);

                    // Powerful Burst
                    const particleCount = 80;
                    const colors = ['#ff0000', '#ffd700', '#ffffff', '#00ff00', '#00704a', '#00ffff', '#ff00ff'];
                    // Pick ONE color for the entire burst
                    const burstColor = colors[Math.floor(Math.random() * colors.length)];

                    const startX = 50 + (Math.random() * 20 - 10);
                    const startY = 50 + (Math.random() * 20 - 10);

                    for (let i = 0; i < particleCount; i++) {
                        const el = document.createElement('div');
                        el.className = 'confetti';

                        el.style.backgroundColor = burstColor;
                        el.style.boxShadow = `0 0 6px 1px ${burstColor}`;
                        el.style.borderRadius = '50%';
                        el.style.width = (Math.random() * 6 + 4) + 'px';
                        el.style.height = el.style.width;
                        el.style.left = startX + 'vw';
                        el.style.top = startY + 'vh';

                        document.body.appendChild(el);

                        const angle = Math.random() * Math.PI * 2;
                        const velocity = 200 + Math.random() * 500;
                        const tx = Math.cos(angle) * velocity;
                        const ty = Math.sin(angle) * velocity;

                        const anim = el.animate([
                            { transform: 'translate(0,0) scale(1)', opacity: 1 },
                            { transform: `translate(${tx * 0.5}px, ${ty * 0.5}px) scale(0.8)`, opacity: 0.8, offset: 0.4 },
                            { transform: `translate(${tx}px, ${ty + 200}px) scale(0)`, opacity: 0 }
                        ], {
                            duration: 1200 + Math.random() * 800,
                            easing: 'cubic-bezier(0, .9, .57, 1)'
                        });

                        anim.onfinish = () => el.remove();
                    }
                }, delay);
            };

            for (let k = 0; k < 5; k++) {
                fireBurst(k * 500);
            }
        }

        function styleGuMode(f) {
            const name = f.properties.name || f.properties.SIG_KOR_NM;
            const s = guStats[name] || { t: 0, v: 0 };
            return { fillColor: getColor(s.t ? s.v / s.t : 0), weight: 1.5, color: 'black', opacity: 1, fillOpacity: 1 };
        }

        function resetUserData() {
            if (confirm("ë°©ë¬¸ ê¸°ë¡ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì„±ë³„/ë‚˜ì´ ì •ë³´ëŠ” ìœ ì§€ë©ë‹ˆë‹¤)")) {
                window.dataLayer.push({ 'event': 'reset_data', 'type': 'all' });

                // Keep user profile, remove others
                localStorage.removeItem('visited_stores');
                localStorage.removeItem('has_seen_guide');
                // localStorage.removeItem('user_profile'); // Preserved!

                location.reload();
            }
        }

        function resetGuData() {
            if (!currentGu || !confirm(`${currentGu}ì˜ ê¸°ë¡ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            window.dataLayer.push({ 'event': 'reset_data', 'type': 'gu', 'gu_name': currentGu });

            const stores = storesByGu[currentGu] || [];
            stores.forEach(s => {
                if (visitedStores.has(s.store_name)) {
                    visitedStores.delete(s.store_name);
                    guStats[currentGu].v--;
                }
            });
            localStorage.setItem('visited_stores', JSON.stringify([...visitedStores]));

            updateDongLayer(currentGu);
            document.getElementById('count-checked').textContent = 0;
        }

        /* Modal & User Flow Logic */
        const modal = document.getElementById('info-modal');
        const welcomeModal = document.getElementById('welcome-modal');
        let userInputs = { age: null, gender: null };

        // 1. Check User Profile on Load
        const storedProfile = localStorage.getItem('user_profile');
        if (!storedProfile) {
            openWelcomeModal();
        } else {
            const p = JSON.parse(storedProfile);
            window.dataLayer.push({ 'user_age': p.age, 'user_gender': p.gender });
            userInputs = p; // Load for editing
            checkAndShowGuide();
        }

        function openWelcomeModal() {
            welcomeModal.style.display = 'flex';

            // Pre-select if editing
            const stored = localStorage.getItem('user_profile');
            if (stored) {
                const p = JSON.parse(stored);
                selectChip('age', p.age);
                selectChip('gender', p.gender);
                document.getElementById('start-btn').textContent = "ìˆ˜ì • ì™„ë£Œ";
            }
        }

        function checkAndShowGuide() {
            if (!localStorage.getItem('has_seen_guide')) {
                // Show Guide immediately if it's the first flow
                openModal();
            }
        }

        function selectChip(type, value) {
            userInputs[type] = value;

            const container = document.getElementById(`${type}-selector`);
            if (!container) return; // Guard clause

            Array.from(container.children).forEach(c => {
                if (c.textContent.trim() === value) c.classList.add('selected');
                else c.classList.remove('selected');
            });

            const btn = document.getElementById('start-btn');
            if (userInputs.age && userInputs.gender) btn.disabled = false;
        }

        function submitUserInfo() {
            if (!userInputs.age || !userInputs.gender) return;

            const isEdit = localStorage.getItem('user_profile') !== null;
            localStorage.setItem('user_profile', JSON.stringify(userInputs));

            window.dataLayer.push({
                'event': isEdit ? 'user_profile_update' : 'user_signup',
                'user_age': userInputs.age,
                'user_gender': userInputs.gender
            });

            welcomeModal.style.display = 'none';

            // If it was a new signup, show guide next. If edit, just close.
            if (!isEdit || !localStorage.getItem('has_seen_guide')) {
                openModal();
            }
        }

        function openModal() { modal.style.display = 'flex'; }

        function closeModal(e, force = false) {
            if (force || e.target === modal) {
                modal.style.display = 'none';
                localStorage.setItem('has_seen_guide', 'true');
            }
        }
    </script>
</body>

</html>